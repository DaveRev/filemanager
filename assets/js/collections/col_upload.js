(function(a,b){a(["underscore","backbone","collections/col_general","modules/mod_async_upload","modules/mod_byteconverter"],function(a,c,d,e,f){function m(a){a===this&&this.trigger("destroyed",this)}function l(b){b.fail(a.bind(j,this)).done(a.bind(k,this));return b}function k(a,b){b==="success"&&this.trigger("success",this,a)}function j(a,b){b==="abort"&&this.trigger("cancled",this),b==="error"&&this.trigger("error",this,$.parseJSON(a.responseText))}var g,h,i;h=c.Model.extend({initialize:function(){this.collection.trigger("create",this),window._m=this,this.collection.on("remove",a.bind(m,this))},parse:function(a){},url:function(){return this.collection.url+"?field_id="+this.get("field_id")},defaults:{context:"",file:[],originalFiles:[],form:"",name:undefined,size:0,type:undefined,id:undefined,field_id:undefined},_createSendData:function(){return{file:this.get("file")}},_filter:function(b,c){var d=c.split(" "),e={};a.each(b,function(b,c){a.include(d,c)&&(e[c]=b)});return e},send:function(){var b=new e({url:this.url()});b.on("progress",a.bind(this._onProgress,this)),this._upload=l.call(this,b.send(this._filter(this.toJSON(),"file context form")))},_onProgress:function(a,b){this.trigger("progress",Math.floor(a/b*100))},_onSuccess:function(){}}),i=function(){function p(a){alert(a)}function o(a){!a.name&&a.fileName&&(a.name=a.fileName),!a.size&&a.fileSize&&(a.size=a.fileSize);return a}function n(a){c[this.cid].push(a),this.trigger("push")}function m(a){e[this.cid].push(a),this.trigger("push")}function l(b){var c=e[this.cid],d=a.indexOf(c,b);d>-1&&(c.splice(d,1),this.trigger("flush"))}function k(b){var d=c[this.cid],e=a.indexOf(d,b);e>-1&&(d.splice(e,1),this._uploads--,this.trigger("flush"))}function j(b){var c=this,d=[],e=a.toArray(b[0].files);a.each(e,function(h,j,k){var l=a.clone(c.model.prototype.defaults);g.call(c,h.type)?i.call(c,h.size)?(l.form=b,l.file=h,l.originalFiles=k,l.name=h.name||h.fileName,l.size=f(h.size||h.fileSize),l.type=h.type,l.id=a.uniqueId(),d.push(l)):(e[j]=null,e.splice(j,1),c.trigger("filesizeexceeds",h.name||h.fileName,h.size)):(e[j]=null,e.splice(j,1),c.trigger("invalidtype",h.name||h.fileName,h.type))});return d}function i(a){return parseInt(this.settings.max_file_size,10)<a?!1:!0}function g(a){var b="("+this.settings.allowed_types.join("|")+")",c;b=b.replace(/\/\*/g,"/.*"),c=new RegExp(b);return a.match(c)?!0:!1}var c={},e={};return d.extend({events:{error:"_onError"},initialize:function(){this.cid=this.cid||"c"+a.uniqueId(),e[this.cid]=[],c[this.cid]=[],this.on("add",a.bind(n,this)),this.on("remove",a.bind(k,this))},url:b.WEBSITE+"/symphony/extension/filemanager/upload/",model:h,addItem:function(a){var b=j.call(this,a);this.add(b)},removeItem:function(a){this.remove(a)},update:function(b,c){var d=this,e;a.isArray(c)?a.each(c,function(a){d.update(b,a)}):(e=this.get(b),e.set(c))},send:function(b){var c=this.get(b),d;c.on("success",a.bind(this.update,this)).on("success error cancled",a.bind(l,this)),d=c.send(),m.call(this,c),k.call(this,c);return c._upload},cancel:function(a){var b=this.get(a);if(b._upload&&!b._upload.isResolved()){b._upload.abort(),n.call(this,b);return!0}return!1},hasActiveUploads:function(){return!!e[this.cid].length},hasPendingUploads:function(){return!!c[this.cid].length}})}(),g=d.extend({constructors:{UploadList:i},addList:function(){var b=new i;a.each(this.settings,function(a,c){b.addSetting(c,a,!0)});return b},initialize:function(){this.settings=a.extend({},g.defaults)}}),g.defaults={field_id:null,allowed_types:["image/jpeg"]};return new g})})(this.define,this.Symphony)