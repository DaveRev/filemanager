(function(a,b,c){c(["jquery","underscore","backbone","collections/col_directories","templates/templates","modules/mod_sysmessage","modules/mod_byteconverter","modules/mod_helper"],function(a,c,d,e,f,g,h,i){var j,k,l,m,n,o={},p=b.Context.get("root"),q=a(document);j=function(){function r(a){this.field.parent().removeClass("active"),q.off("keyup.searchlist")}function p(a){this.field.parent().addClass("active"),q.on("keyup.searchlist",c.bind(l,this))}function o(b){var c=a("#result-"+b.id);c.length&&c.remove()}function n(b){var c=a("#result-"+b.id);c.length&&c[b.get("selected")?"addClass":"removeClass"]("selected")}function m(){l.call(this,{keyCode:27})}function l(a){a.keyCode===27&&(this.reset(),this.field.val("").blur())}function k(d){var i,j,k;e++,this.reset(),h=this.options.threshold,this.options.threshold=0,e=0,i=d.target,j=this.collection.searchFiles(i.value),k=j.length,this.counter=a(f.search_count({found:b.Language.get(g[k===1?"count_file_found":"count_files_found"],{count:k})})),c.each(j,c.bind(this.render,this)),this.field.after(this.counter)}function j(b){b.preventDefault();var c=a([a(b.target),a(b.target).parents().filter("li")]).filter(function(){return this.hasClass("result-item")}),d=c[0][0].id.replace(/result/,"file");c.addClass("selected");var e=this.collection.getFileById(parseInt(d.substr(5),10));e.set("selected",!0)}var e=0,h;return d.View.extend({events:{"click.searchlist .result-item:not(.selected)":j,"focus.searchlist input[type=text]":p,"blur.searchlist input[type=text]":r,"click.searchlist .remove":m,"keyup.searchlist input[type=text]":k},initialize:function(){this.template=f.search_list,this.list=this.$el.find(".results"),this.field=this.$el.find("input[type=text]"),this.collection.on("selected",c.bind(n,this)).on("filedelete",c.bind(o,this))},reset:function(){this.options.threshold=h,this.list.empty(),this.counter&&this.counter.remove()},render:function(a){var b=a.toJSON(),c;b.thumb=i.getThumbURL(a,"/image/2/40/40/5"),c=this.template(b),this.list.append(c)}})}(),m=function(){function e(a){console.log(arguments),a.get("selected")?this.$el.addClass("file-selected"):this.$el.removeClass("file-selected")}function b(a){a.preventDefault(),a.stopPropagation(),this.close()}return d.View.extend({events:{"click.meta .close":b},initialize:function(){var a;this._rendered=!1,this.$el.on("destroyed",c.bind(this.remove,this)),a=c.bind(e,this),this.options.parentView.model.on("change:selected",a)},render:function(){var a,b;if(this._rendered)return this;a=c.extend(this.model.toJSON(),{preview:i.getThumbURL(this.model,"/image/1/0/150"),size:h(this.model.get("size"))+" ("+this.model.get("size")+")"}),b=f.meta(a),this.el.innerHTML=b,this._rendered=!0;return this},open:function(b){var c=this,d=a("#file-"+this.options.parentView.model.id);if(!this._rendered){this.render(),this.open(b);return this}this.$el.insertAfter(d),this.delegateEvents(),b?this.$el.css({display:"block"}):this.$el.slideDown(),this._open=!0,this.trigger("open",this),e.call(this,this.options.parentView.model);return this},close:function(a){var b=this;this._open=!1,this.$el.slideUp(function(){a?b.$el.remove():b.undelegateEvents()}),!a&&this.trigger("close",this)},remove:function(){this.undelegateEvents(),this.trigger("remove")}})}(),m.makeView=function(){if(this instanceof d.View)return new m({parentView:this,tagName:"li",model:this.model,id:"meta-for-"+this.model.id,className:"meta-view",idPrefix:"meta-for-"});throw"makeView called with wrong context"},k=function(){function a(a){var b,c;a===this.model&&this._metaView&&(b=this._metaView,c=a.get("dir").get("path"),this._metaView.close(!0))}return d.View.extend({initialize:function(){this.model.collection.on("remove",c.bind(a,this))},render:function(a){a=a||{};var b=this,d=f.files(c.extend(this.model.toJSON(),{settings:a}));this.el.innerHTML+=d,setTimeout(function(){b.$el.find("#preview-"+b.model.id).on("click.file",c.bind(b.showMetaInfo,b))},0)},setMetaView:function(){var a=this.model.get("path"),b=this.dirView,c;this._metaView||(c=b.model.collection.cid,this._metaView=m.makeView.call(this),this._metaView.on("open",function(){o[c][a]=!0}).on("close",function(){delete o[c][a]}))},showMetaInfo:function(a){a.preventDefault(),a.stopPropagation(),this.setMetaView(),this._metaView.open()}})}(),l=function(){function g(){var b={},d=this.$el.find(".toolbar:first");c.each(a,function(a){var c=d.find("."+a);c.length&&(b[a]=c)}),this._tasks=b}function e(a,b){this._tasks[a]&&this._tasks[a].addClass("disabled")}function b(a,b){this._tasks[a]&&this._tasks[a].removeClass("disabled")}var a="upload create move delete".split(" ");return d.View.extend({events:{},initialize:function(){var a=this;this.fileViews=[],this._files={},this.on("enabletask",c.bind(b,this)).on("disabletask",c.bind(e,this))},render:function(a,b,d){var e=this,h=c.clone(a),i,j=this.model.get("parent"),l=this.model.get("files"),m;this.$el.html(f.dirs(c.extend(this.model.toJSON(),{settings:c.extend(h,b)}))),m=this.$el.find("#sub-"+this.model.id),l&&(l.on("remove",c.bind(e.model.collection.trigger,e.model.collection,"remove")),l.each(function(a){var c=new k({el:m,model:a});c.dirView=e,e._files[a.get("path")]=c,e.fileViews.push(c),c.render(b)})),i=j?document.getElementById("sub-"+j.id):document.getElementById("dir-list-root-"+this.model.collection.cid),i&&!d&&this.$el.appendTo(i),g.call(this),this.model.get("state")==="open"&&(this.$el.addClass(this.model.get("state")),this.$el.find("> .sub-dir").css({display:"block"})),d&&this.trigger("update",this)},getFileViewById:function(a){var b;a=isNaN(a)?parseInt(a.replace("file-",""),10):a,b=c.find(this.fileViews,function(b){return b.model.id===a});return b},getFileByPath:function(a){return this._files[a]},getSubDirs:function(){var a=this.model.get("subdirs")}})}(),n=function(){function G(a){var b=new g(null,a),c=f.dirtree_error({message:b.getMessage()});this.el.innerHTML=c}function F(a){var b=c.keys(o[this.collection.cid]),d,e=this,f,g=[],h=this.getDirViewByModel(a);!b.length||c.each(b,function(a){var b=e.collection.getByFileName(a),c;c=b.length?e.getFileViewByModel(b[0]):null,c&&c&&(c.setMetaView(),c._metaView.open(!0))})}function E(){this.$el.find(".draggable:not(.ui-draggable)").trigger("mouseenter").end().find(".droppable:not(.ui-droppable)").trigger("mouseenter")}function D(){var b=this,d=this.$el.find(".droppable:not(.ui-droppable)");d.droppable({drop:c.bind(w,this),greedy:!0,tolerance:"intersect",hoverClass:"dropover",scope:"moveable",over:function(c,e){d.on("toggleopen.itemdraggover",function(){var c=a(this),d=c.parent();C(c,d,b)}),setTimeout(function(){d.trigger("toggleopen.itemdraggover",[c,e])},600)},out:function(a,b){d.off("toggleopen.itemdraggover")}}),d.on("destroyed",A);return this}function C(a,b,c){b.hasClass("open")||(a.on("dropout.itemdraggover",function(a,d){c.closeDir(b)}),c.openDir(b))}function B(){var a=this.$el.find(".draggable:not(.ui-draggable)");a.draggable({revert:!0,revertDuration:120,cursor:"move",axis:"y",handle:".move",opacity:.7,snap:!0,zIndex:2700,scope:"moveable"}),a.on("destroyed",z);return this}function A(){a(this).droppable("destroy")}function z(){a(this).draggable("destroy")}function y(b){b.preventDefault(),b.stopPropagation();var d;if(!!/droppable/.test(b.target.className)){d=a(b.target).add(".droppable"),d.droppable({drop:c.bind(w,this),greedy:!0,tolerance:"intersect",hoverClass:"dropover",scope:"moveable"});return this}}function x(b){b.preventDefault(),b.stopPropagation();var c;if(!!/draggable/.test(b.target.className)){c=a(b.target),c.draggable({revert:!0,revertDuration:120,cursor:"move",axis:"y",handle:".move",opacity:.7,snap:!0,zIndex:2700,scope:"moveable"});return this}}function w(b,c){b.preventDefault(),b.stopPropagation();var d=c.draggable,e=/file/.test(d[0].className)?"file":"dir",f=a(b.target).parent()[0].id,h=e==="file"?d.parents().filter("li.dir")[0].id:d.parent()[0].id,i=e==="file"?d[0].id.substr(5):undefined;this.collection.moveItem({type:e,destination:f,source:h,file:e==="file"?parseInt(i,10):i}).always(function(a){new g(null,a)})}function v(a){a=a instanceof d.Model?a:this.collection.get(a.directory.id);return this.renderPart(a)}function u(a,b){var c=b.find("input[type=text]").val();this.collection.createDir(c,a).always(function(a){b.off("click",".confirm"),b.remove();var c=new g(null,a)})}function t(a,b,c){var d=/dir/.test(a.id);d||this.trigger("select","remove",a);return s.call(this,a.id,d?"dir":"file")}function s(b,c){if(!this instanceof d.View)throw"function called with wrong context";var e=c==="file"?a("#file-"+b):a("#"+b),f=a([e,e.find(".dir-header")]).filter(function(){return this.data("draggable")||this.data("droppable")});this.dirViews[b]&&delete this.dirViews[b],e.detach(),setTimeout(function(){e.remove()},100);return this}function r(a){var b=this,d=a.get("selected"),e,f=h[this.cid],g=d?"selectById":"unselectById",i;this.canSelectMultiple()?(e=a.collection.getFilesByIndexRange(a.index(),f.index()),c.each(e,function(a){a.set("selected",d),b[g](a.id),i=a})):(i=a,this[g](a.id)),d&&(h[this.cid]=i)}function p(a){a.keyCode===16&&(this.$el.off("selectstart.dirtree"),k[this.cid]=!1)}function n(a){a.keyCode===16&&(k[this.cid]=!0,this.$el.on("selectstart.dirtree",function(a){a.preventDefault()}))}function m(a,b){var c=this.collection.getFileById(parseInt(a.target.id.replace("select-file-",""),10)),d=b==="add"?"select":"unselect",e=b==="add"?!0:!1;this.trigger("select",b,c.toJSON()),c.set("selected",e)}var h={},k={};return d.View.extend({events:{"click.dritree .toolbar":"tasks","click.dirtree .dir-header":"toggleDir","click.dirtree .file:not(.selected) > .text":"select","click.dirtree .file.selected > .text":"unselect","click.dirtree .file > .toolbar > .delete":"deleteFile","click.dirtree .dir-header > .toolbar > .delete":"deleteDir","click.dirtree .dir-header > .toolbar > .create":"createDir"},initialize:function(){var a=this;this.collection=new e,this.dirViews={},this.collection.addSetting("field_id",this.options.field_id),this.collection.populate(),this.collection.deferred.done(c.bind(this.render,this)).fail(c.bind(G,this)),this.collection.on("add",c.bind(this.renderPart,this)),this.collection.on("remove",c.bind(t,this)),this.collection.on("update",c.debounce(c.bind(F,this),0)),this.collection.on("selected",c.bind(r,this)),o[this.collection.cid]={},this.searchView=new j({el:f.search_bar({id:"search-"+this.cid}),threshold:3,collection:this.collection}),this._canSelectMultiple=!1,h[this.cid]=null,this.$el.parent().find("label").after(this.searchView.$el),q.on("keydown.dirtree",c.bind(n,this)).on("keyup.dirtree",c.bind(p,this))},canSelectMultiple:function(){return k[this.cid]},tasks:function(b){var c=a(b.target).parents().filter("li").find("ul")[0].id.substr(4),d=b.target.className.split(" ")[1];this.trigger(d,this.collection.get(c));return!1},select:function(a){m.call(this,a,"add")},unselect:function(a){m.call(this,a,"remove")},selectById:function(a){this.filesById(a).addClass("selected");return this},unselectById:function(a){this.filesById(a).removeClass("selected");return this},filesById:function(b){return a(c.isArray(b)?"#file-"+b.join(", #file-"):"#file-"+b)},getFile:function(a){return this.collection.getFileById(parseInt(a[0].id.split("file-")[1],10))},confirm:function(a){return confirm(a)},deleteDir:function(c){var d=this.collection.get(a(c.target).parents().filter(".dir")[0].id),e=b.Language.get(g.confirm_directory_deletion,{dir:d.get("name"),dir2:d.get("name"),dircount:d.get("subdirs")?d.get("subdirs").length:0,filecount:d.get("files")?d.get("files").models.length:0});this.confirm(e)&&this.collection.deleteItem(d,"dir").always(function(a){new g(null,a)})},deleteFile:function(c){var d=a(c.target),e=d.parents().filter(".file"),f=e.parent(),h=this.getFile(e),i=b.Language.get(g.confirm_file_deletion,{file:h.get("name")||h.get("path")});this.confirm(i)&&this.collection.deleteItem(h,"file").always(function(a){new g(null,a)}).done(function(){h.get("selected")&&h.set("selected",!1)})},createDir:function(b){var d=a(b.target),e=this.collection.get(d.parents().filter(".dir")[0].id),g=a(f.newdir({parent:e.get("path"),level:~~e.get("level")+1}));a("#sub-"+e.id).prepend(g),this.openDir(d.parents().filter(".dir")),g.on("click",".add",c.bind(u,this,e,g)),g.on("click",".cancel",function(){g.remove()})},toggleDir:function(b){var c,d,e,f;b.preventDefault(),b.stopPropagation(),c=a(b.target).parents().filter(".dir:not(#dir-list-root-"+this.collection.cid+")").first(),d=c.find("> .sub-dir"),e=c.hasClass("open")?"close":"open",f=e==="open"?"openDir":"closeDir",this[f](c)},openDir:function(a){i.isjQueryObject(a)&&(a.find("> .sub-dir").slideDown(),a.addClass("open"),this.collection.get(a[0].id).set("state","open"))},closeDir:function(a){a.find("> .sub-dir").slideUp(),a.removeClass("open"),this.collection.get(a[0].id).set("state","close")},enableTask:function(a,b){this.dirViews[b.id].trigger("enabletask",a)},disableTask:function(a,b){this.dirViews[b.id].trigger("disabletask",a)},renderPart:function(a){var b,d=this.dirViews[a.id]?!0:!1;d?(b=this.dirViews[a.id],b.model=a):(b=new l({tagName:"li",id:a.id,className:"dir level-"+a.get("level"),model:a}),this.dirViews[a.id]=b),b.render(this.options.dirSettings,this.options.fileSettings,d),d&&c.isArray(a.get("subdirs"))&&c.each(a.get("subdirs"),c.bind(v,this)),d&&this.trigger("update",b),B.call(this),D.call(this)},render:function(){var a=this;this.el.innerHTML=f.dirtree({name:this.options.baseName,cid:this.collection.cid}),this.collection.each(c.bind(this.renderPart,this))},getSubdirsFromView:function(a,b){var d=this,e=a.model.get("subdirs"),f=[];e&&c.each(e,function(a){d.dirViews[a.id]&&(f.push(d.dirViews[a.id]),b&&a.get("subdirs")&&f.push.apply(f,d.getSubdirsFromView(d.dirViews[a.id],!0)))});return f},getDirViewByModel:function(a){return this.dirViews[a.id]},getDirViewById:function(a){return this.dirViews[a]},getFileViewByModel:function(a){var b=this.getDirViewById(a.get("dir").id),c=b.getFileViewById(a.id);return c}})}();return n})})(this,this.Symphony,this.define)