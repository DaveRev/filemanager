(function(a,b,c){c(["jquery","underscore","backbone","collections/col_directories","templates/templates","modules/mod_sysmessage","modules/mod_byteconverter","modules/mod_helper"],function(a,c,d,e,f,g,h,i){var j,k,l,m,n={},o=b.Context.get("root"),p=a(document);l=function(){function e(a){a.get("selected")?this.$el.addClass("file-selected"):this.$el.removeClass("file-selected")}function b(a){a.preventDefault(),a.stopPropagation(),this.close()}return d.View.extend({events:{"click.meta .close":b},initialize:function(){var a;this._rendered=!1,this.$el.on("destroyed",c.bind(this.remove,this)),a=c.bind(e,this),this.options.parentView.model.on("change:selected",a)},render:function(){var a,b;if(this._rendered)return this;a=c.extend(this.model.toJSON(),{preview:i.getThumbURL(this.model,"/image/1/0/150"),size:h(this.model.get("size"))+" ("+this.model.get("size")+")"}),b=f.meta(a),this.el.innerHTML=b,this._rendered=!0;return this},open:function(b){var c=this,d=a("#file-"+this.options.parentView.model.id);if(!this._rendered){this.render(),this.open(b);return this}this.$el.insertAfter(d),this.delegateEvents(),b?this.$el.css({display:"block"}):this.$el.slideDown(),this._open=!0,this.trigger("open",this),e.call(this,this.options.parentView.model);return this},close:function(a){var b=this;this._open=!1,this.$el.slideUp(function(){a?b.$el.remove():b.undelegateEvents()}),!a&&this.trigger("close",this)},remove:function(){this.undelegateEvents(),this.trigger("remove")}})}(),l.makeView=function(){if(this instanceof d.View)return new l({parentView:this,tagName:"li",model:this.model,id:"meta-for-"+this.model.id,className:"meta-view",idPrefix:"meta-for-"});throw"makeView called with wrong context"},j=function(){function a(a){var b,c;a===this.model&&this._metaView&&(b=this._metaView,c=a.get("dir").get("path"),this._metaView.close(!0))}return d.View.extend({initialize:function(){this.model.collection.on("remove",c.bind(a,this))},render:function(a){a=a||{};var b=this,d=f.files(c.extend(this.model.toJSON(),{settings:a}));this.el.innerHTML+=d,setTimeout(function(){b.$el.find("#preview-"+b.model.id).on("click.file",c.bind(b.showMetaInfo,b))},0)},setMetaView:function(){var a=this.model.get("path"),b=this.dirView,c;this._metaView||(c=b.model.collection.cid,this._metaView=l.makeView.call(this),this._metaView.on("open",function(){n[c][a]=!0}).on("close",function(){delete n[c][a]}))},showMetaInfo:function(a){a.preventDefault(),a.stopPropagation(),this.setMetaView(),this._metaView.open()}})}(),k=function(){function g(){var b={},d=this.$el.find(".toolbar:first");c.each(a,function(a){var c=d.find("."+a);c.length&&(b[a]=c)}),this._tasks=b}function e(a,b){this._tasks[a]&&this._tasks[a].addClass("disabled")}function b(a,b){this._tasks[a]&&this._tasks[a].removeClass("disabled")}var a="upload create move delete".split(" ");return d.View.extend({events:{},initialize:function(){var a=this;this.fileViews=[],this._files={},this.on("enabletask",c.bind(b,this)).on("disabletask",c.bind(e,this))},render:function(a,b,d){var e=this,h=c.clone(a),i,k=this.model.get("parent"),l=this.model.get("files"),m;this.$el.html(f.dirs(c.extend(this.model.toJSON(),{settings:c.extend(h,b)}))),m=this.$el.find("#sub-"+this.model.id),l&&(l.on("remove",c.bind(e.model.collection.trigger,e.model.collection,"remove")),l.each(function(a){var c=new j({el:m,model:a});c.dirView=e,e._files[a.get("path")]=c,e.fileViews.push(c),c.render(b)})),i=k?document.getElementById("sub-"+k.id):document.getElementById("dir-list-root-"+this.model.collection.cid),i&&!d&&this.$el.appendTo(i),g.call(this),this.model.get("state")==="open"&&(this.$el.addClass(this.model.get("state")),this.$el.find("> .sub-dir").css({display:"block"})),d&&this.trigger("update",this)},getFileViewById:function(a){var b;a=isNaN(a)?parseInt(a.replace("file-",""),10):a,b=c.find(this.fileViews,function(b){return b.model.id===a});return b},getFileByPath:function(a){return this._files[a]},getSubDirs:function(){var a=this.model.get("subdirs")}})}(),m=function(){function F(a){var b=new g(null,a),c=f.dirtree_error({message:b.getMessage()});this.el.innerHTML=c}function E(a){var b=c.keys(n[this.collection.cid]),d,e=this,f,g=[],h=this.getDirViewByModel(a);!b.length||c.each(b,function(a){var b=e.collection.getByFileName(a),c;c=b.length?e.getFileViewByModel(b[0]):null,c&&c&&(c.setMetaView(),c._metaView.open(!0))})}function D(){this.$el.find(".draggable:not(.ui-draggable)").trigger("mouseenter").end().find(".droppable:not(.ui-droppable)").trigger("mouseenter")}function C(){var b=this,d=this.$el.find(".droppable:not(.ui-droppable)");d.droppable({drop:c.bind(v,this),greedy:!0,tolerance:"intersect",hoverClass:"dropover",scope:"moveable",over:function(c,e){d.on("toggleopen.itemdraggover",function(){var c=a(this),d=c.parent();B(c,d,b)}),setTimeout(function(){d.trigger("toggleopen.itemdraggover",[c,e])},600)},out:function(a,b){d.off("toggleopen.itemdraggover")}}),d.on("destroyed",z);return this}function B(a,b,c){b.hasClass("open")||(a.on("dropout.itemdraggover",function(a,d){c.closeDir(b)}),c.openDir(b))}function A(){var a=this.$el.find(".draggable:not(.ui-draggable)");a.draggable({revert:!0,revertDuration:120,cursor:"move",axis:"y",handle:".move",opacity:.7,snap:!0,zIndex:2700,scope:"moveable"}),a.on("destroyed",y);return this}function z(){a(this).droppable("destroy")}function y(){a(this).draggable("destroy")}function x(b){b.preventDefault(),b.stopPropagation();var d;if(!!/droppable/.test(b.target.className)){d=a(b.target).add(".droppable"),d.droppable({drop:c.bind(v,this),greedy:!0,tolerance:"intersect",hoverClass:"dropover",scope:"moveable"});return this}}function w(b){b.preventDefault(),b.stopPropagation();var c;if(!!/draggable/.test(b.target.className)){c=a(b.target),c.draggable({revert:!0,revertDuration:120,cursor:"move",axis:"y",handle:".move",opacity:.7,snap:!0,zIndex:2700,scope:"moveable"});return this}}function v(b,c){b.preventDefault(),b.stopPropagation();var d=c.draggable,e=/file/.test(d[0].className)?"file":"dir",f=a(b.target).parent()[0].id,h=e==="file"?d.parents().filter("li.dir")[0].id:d.parent()[0].id,i=e==="file"?d[0].id.substr(5):undefined;this.collection.moveItem({type:e,destination:f,source:h,file:e==="file"?parseInt(i,10):i}).always(function(a){new g(null,a)})}function u(a){a=a instanceof d.Model?a:this.collection.get(a.directory.id);return this.renderPart(a)}function t(a,b){var c=b.find("input[type=text]").val();this.collection.createDir(c,a).always(function(a){b.off("click",".confirm"),b.remove();var c=new g(null,a)})}function s(a,b,c){var d=/dir/.test(a.id);d||this.trigger("select","remove",a);return r.call(this,a.id,d?"dir":"file")}function r(b,c){if(!this instanceof d.View)throw"function called with wrong context";var e=c==="file"?a("#file-"+b):a("#"+b),f=a([e,e.find(".dir-header")]).filter(function(){return this.data("draggable")||this.data("droppable")});this.dirViews[b]&&delete this.dirViews[b],e.detach(),setTimeout(function(){e.remove()},100);return this}function q(a){var b=this,d=a.get("selected"),e,f=h[this.cid],g=d?"selectById":"unselectById",i;this.canSelectMultiple()?(e=a.collection.getFilesByIndexRange(a.index(),f.index()),c.each(e,function(a){a.set("selected",d),b[g](a.id),i=a})):(i=a,this[g](a.id)),d&&(h[this.cid]=i)}function o(a){a.keyCode===16&&(this.$el.off("selectstart.dirtree"),j[this.cid]=!1)}function m(a){a.keyCode===16&&(j[this.cid]=!0,this.$el.on("selectstart.dirtree",function(a){a.preventDefault()}))}function l(a,b){var c=this.collection.getFileById(parseInt(a.target.id.replace("select-file-",""),10)),d=b==="add"?"select":"unselect",e=b==="add"?!0:!1;this.trigger("select",b,c.toJSON()),c.set("selected",e)}var h={},j={};return d.View.extend({events:{"click.dritree .toolbar":"tasks","click.dirtree .dir-header":"toggleDir","click.dirtree .file:not(.selected) > .text":"select","click.dirtree .file.selected > .text":"unselect","click.dirtree .file > .toolbar > .delete":"deleteFile","click.dirtree .dir-header > .toolbar > .delete":"deleteDir","click.dirtree .dir-header > .toolbar > .create":"createDir"},initialize:function(){var a=this;this.collection=new e,this.dirViews={},this.collection.addSetting("field_id",this.options.field_id),this.collection.populate(),this.collection.deferred.done(c.bind(this.render,this)).fail(c.bind(F,this)),this.collection.on("add",c.bind(this.renderPart,this)),this.collection.on("remove",c.bind(s,this)),this.collection.on("update",c.debounce(c.bind(E,this),0)),this.collection.on("selected",c.bind(q,this)),n[this.collection.cid]={},this._canSelectMultiple=!1,h[this.cid]=null,p.on("keydown.dirtree",c.bind(m,this)).on("keyup.dirtree",c.bind(o,this))},canSelectMultiple:function(){return j[this.cid]},tasks:function(b){var c=a(b.target).parents().filter("li").find("ul")[0].id.substr(4),d=b.target.className.split(" ")[1];this.trigger(d,this.collection.get(c));return!1},select:function(a){l.call(this,a,"add")},unselect:function(a){l.call(this,a,"remove")},selectById:function(a){this.filesById(a).addClass("selected");return this},unselectById:function(a){this.filesById(a).removeClass("selected");return this},filesById:function(b){return a(c.isArray(b)?"#file-"+b.join(", #file-"):"#file-"+b)},getFile:function(a){return this.collection.getFileById(parseInt(a[0].id.split("file-")[1],10))},confirm:function(a){return confirm(a)},deleteDir:function(c){var d=this.collection.get(a(c.target).parents().filter(".dir")[0].id),e=b.Language.get(g.confirm_directory_deletion,{dir:d.get("name"),dir2:d.get("name"),dircount:d.get("subdirs")?d.get("subdirs").length:0,filecount:d.get("files")?d.get("files").models.length:0});this.confirm(e)&&this.collection.deleteItem(d,"dir").always(function(a){new g(null,a)})},deleteFile:function(c){var d=a(c.target),e=d.parents().filter(".file"),f=e.parent(),h=this.getFile(e),i=b.Language.get(g.confirm_file_deletion,{file:h.get("name")||h.get("path")});this.confirm(i)&&this.collection.deleteItem(h,"file").always(function(a){new g(null,a)}).done(function(){h.get("selected")&&h.set("selected",!1)})},createDir:function(b){var d=a(b.target),e=this.collection.get(d.parents().filter(".dir")[0].id),g=a(f.newdir({parent:e.get("path"),level:~~e.get("level")+1}));a("#sub-"+e.id).prepend(g),this.openDir(d.parents().filter(".dir")),g.on("click",".add",c.bind(t,this,e,g)),g.on("click",".cancel",function(){g.remove()})},toggleDir:function(b){var c,d,e,f;b.preventDefault(),b.stopPropagation(),c=a(b.target).parents().filter(".dir:not(#dir-list-root-"+this.collection.cid+")").first(),d=c.find("> .sub-dir"),e=c.hasClass("open")?"close":"open",f=e==="open"?"openDir":"closeDir",this[f](c)},openDir:function(a){i.isjQueryObject(a)&&(a.find("> .sub-dir").slideDown(),a.addClass("open"),this.collection.get(a[0].id).set("state","open"))},closeDir:function(a){a.find("> .sub-dir").slideUp(),a.removeClass("open"),this.collection.get(a[0].id).set("state","close")},enableTask:function(a,b){this.dirViews[b.id].trigger("enabletask",a)},disableTask:function(a,b){this.dirViews[b.id].trigger("disabletask",a)},renderPart:function(a){var b,d=this.dirViews[a.id]?!0:!1;d?(b=this.dirViews[a.id],b.model=a):(b=new k({tagName:"li",id:a.id,className:"dir level-"+a.get("level"),model:a}),this.dirViews[a.id]=b),b.render(this.options.dirSettings,this.options.fileSettings,d),d&&c.isArray(a.get("subdirs"))&&c.each(a.get("subdirs"),c.bind(u,this)),d&&this.trigger("update",b),A.call(this),C.call(this)},render:function(){var a=this;this.el.innerHTML=f.dirtree({name:this.options.baseName,cid:this.collection.cid}),this.collection.each(c.bind(this.renderPart,this))},getSubdirsFromView:function(a,b){var d=this,e=a.model.get("subdirs"),f=[];e&&c.each(e,function(a){d.dirViews[a.id]&&(f.push(d.dirViews[a.id]),b&&a.get("subdirs")&&f.push.apply(f,d.getSubdirsFromView(d.dirViews[a.id],!0)))});return f},getDirViewByModel:function(a){return this.dirViews[a.id]},getDirViewById:function(a){return this.dirViews[a]},getFileViewByModel:function(a){var b=this.getDirViewById(a.get("dir").id),c=b.getFileViewById(a.id);return c}})}(),c.extend(m,{DirView:k,FileView:j,MetaView:l});return m})})(this,this.Symphony,this.define)