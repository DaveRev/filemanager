(function(a,b,c){c(["jquery","underscore","backbone","collections/col_directories","templates/templates","modules/mod_sysmessage","modules/mod_byteconverter","modules/mod_helper"],function(c,d,e,f,g,h,i,j){var k,l,m,n,o,p={},q=b.Context.get("root"),r=c(document);k=function(){function q(a){this.field.parent().removeClass("active"),r.off("keyup.searchlist")}function p(a){this.field.parent().addClass("active"),r.on("keyup.searchlist",d.bind(l,this))}function o(a){var b=c("#result-"+a.id);b.length&&b.remove()}function n(a){var b=c("#result-"+a.id);b.length&&b[a.get("selected")?"addClass":"removeClass"]("selected")}function m(){l.call(this,{keyCode:27})}function l(a){a.keyCode===27&&(this.reset(),this.field.val("").blur())}function k(e){var i,j,k;a++,this.reset(),f=this.options.threshold,this.options.threshold=0,a=0,i=e.target,j=this.collection.searchFiles(i.value),k=j.length,this.counter=c(g.search_count({found:b.Language.get(h[k===1?"count_file_found":"count_files_found"],{count:k})})),d.each(j,d.bind(this.render,this)),this.field.after(this.counter)}function i(a){a.preventDefault();var b=c([c(a.target),c(a.target).parents().filter("li")]).filter(function(){return this.hasClass("result-item")}),d;d=b[0][0].id.replace(/result/,"file"),b.addClass("selected");var e=this.collection.getFileById(parseInt(d.substr(5),10));e.set("selected",!0)}var a=0,f;return e.View.extend({events:{"click.searchlist .result-item:not(.selected)":i,"focus.searchlist input[type=text]":p,"blur.searchlist input[type=text]":q,"click.searchlist .remove":m,"keyup.searchlist input[type=text]":k},initialize:function(){this.template=g.search_list,this.list=this.$el.find(".results"),this.field=this.$el.find("input[type=text]"),this.collection.on("selected",d.bind(n,this)).on("filedelete",d.bind(o,this))},reset:function(){this.options.threshold=f,this.list.empty(),this.counter&&this.counter.remove()},render:function(a){var b=a.toJSON(),c;b.thumb=j.getThumbURL(a,"/image/2/40/40/5"),c=this.template(b),this.list.append(c)}})}(),n=function(){function b(a){console.log(arguments),a.get("selected")?this.$el.addClass("file-selected"):this.$el.removeClass("file-selected")}function a(a){a.preventDefault(),a.stopPropagation(),this.close()}return e.View.extend({events:{"click.meta .close":a},initialize:function(){var a;this._rendered=!1,this.$el.on("destroyed",d.bind(this.remove,this)),a=d.bind(b,this),this.options.parentView.model.on("change:selected",a)},render:function(){var a,b;if(this._rendered)return this;a=d.extend(this.model.toJSON(),{preview:j.getThumbURL(this.model,"/image/1/0/150"),size:i(this.model.get("size"))+" ("+this.model.get("size")+")"}),b=g.meta(a),this.el.innerHTML=b,this._rendered=!0;return this},open:function(a){var d=this,e=c("#file-"+this.options.parentView.model.id);if(!this._rendered){this.render(),this.open(a);return this}this.$el.insertAfter(e),this.delegateEvents(),a?this.$el.css({display:"block"}):this.$el.slideDown(),this._open=!0,this.trigger("open",this),b.call(this,this.options.parentView.model);return this},close:function(a){var b=this;this._open=!1,this.$el.slideUp(function(){a?b.$el.remove():b.undelegateEvents()}),!a&&this.trigger("close",this)},remove:function(){this.undelegateEvents(),this.trigger("remove")}})}(),n.makeView=function(){if(this instanceof e.View)return new n({parentView:this,tagName:"li",model:this.model,id:"meta-for-"+this.model.id,className:"meta-view",idPrefix:"meta-for-"});throw"makeView called with wrong context"},l=function(){function a(a){var b,c;a===this.model&&this._metaView&&(b=this._metaView,c=a.get("dir").get("path"),this._metaView.close(!0))}return e.View.extend({initialize:function(){this.model.collection.on("remove",d.bind(a,this))},render:function(a){a=a||{};var b=this,c=g.files(d.extend(this.model.toJSON(),{settings:a}));this.el.innerHTML+=c,setTimeout(function(){b.$el.find("#preview-"+b.model.id).on("click.file",d.bind(b.showMetaInfo,b))},0)},setMetaView:function(){var a=this.model.get("path"),b=this.dirView,c;this._metaView||(c=b.model.collection.cid,this._metaView=n.makeView.call(this),this._metaView.on("open",function(){p[c][a]=!0}).on("close",function(){delete p[c][a]}))},showMetaInfo:function(a){a.preventDefault(),a.stopPropagation(),this.setMetaView(),this._metaView.open()}})}(),m=function(){function f(){var b={},c=this.$el.find(".toolbar:first");d.each(a,function(a){var d=c.find("."+a);d.length&&(b[a]=d)}),this._tasks=b}function c(a,b){this._tasks[a]&&this._tasks[a].addClass("disabled")}function b(a,b){this._tasks[a]&&this._tasks[a].removeClass("disabled")}var a="upload create move delete".split(" ");return e.View.extend({events:{},initialize:function(){var a=this;this.fileViews=[],this._files={},this.on("enabletask",d.bind(b,this)).on("disabletask",d.bind(c,this))},render:function(a,b,c){var e=this,h=d.clone(a),i,j=this.model.get("parent"),k=this.model.get("files"),m;this.$el.html(g.dirs(d.extend(this.model.toJSON(),{settings:d.extend(h,b)}))),m=this.$el.find("#sub-"+this.model.id),k&&(k.on("remove",d.bind(e.model.collection.trigger,e.model.collection,"remove")),k.each(function(a){var c=new l({el:m,model:a});c.dirView=e,e._files[a.get("path")]=c,e.fileViews.push(c),c.render(b)})),i=j?document.getElementById("sub-"+j.id):document.getElementById("dir-list-root-"+this.model.collection.cid),i&&!c&&this.$el.appendTo(i),f.call(this),this.model.get("state")==="open"&&(this.$el.addClass(this.model.get("state")),this.$el.find("> .sub-dir").css({display:"block"})),c&&this.trigger("update",this)},getFileViewById:function(a){var b;a=isNaN(a)?parseInt(a.replace("file-",""),10):a,b=d.find(this.fileViews,function(b){return b.model.id===a});return b},getFileByPath:function(a){return this._files[a]},getSubDirs:function(){var a=this.model.get("subdirs")}})}(),o=function(){function C(a){var b=new h(null,a),c=g.dirtree_error({message:b.getMessage()});this.el.innerHTML=c}function B(a){var b=d.keys(p[this.collection.cid]),c,e=this,f,g=[],h=this.getDirViewByModel(a);!b.length||d.each(b,function(a){var b=e.collection.getByFileName(a),c;c=b.length?e.getFileViewByModel(b[0]):null,c&&c&&(c.setMetaView(),c._metaView.open(!0))})}function A(){this.$el.find(".draggable:not(.ui-draggable)").trigger("mouseenter").end().find(".droppable:not(.ui-droppable)").trigger("mouseenter")}function z(){var a=this,b=this.$el.find(".droppable:not(.ui-droppable)");b.droppable({drop:d.bind(s,this),greedy:!0,tolerance:"intersect",hoverClass:"dropover",scope:"moveable",over:function(d,e){b.on("toggleopen.itemdraggover",function(){var b=c(this),d=b.parent();y(b,d,a)}),setTimeout(function(){b.trigger("toggleopen.itemdraggover",[d,e])},600)},out:function(a,c){b.off("toggleopen.itemdraggover")}}),b.on("destroyed",w);return this}function y(a,b,c){b.hasClass("open")||(a.on("dropout.itemdraggover",function(a,d){c.closeDir(b)}),c.openDir(b))}function x(){var a=this.$el.find(".draggable:not(.ui-draggable)");a.draggable({revert:!0,revertDuration:120,cursor:"move",axis:"y",handle:".move",opacity:.7,snap:!0,zIndex:2700,scope:"moveable"}),a.on("destroyed",v);return this}function w(){c(this).droppable("destroy")}function v(){c(this).draggable("destroy")}function u(a){a.preventDefault(),a.stopPropagation();var b;if(!!/droppable/.test(a.target.className)){b=c(a.target).add(".droppable"),b.droppable({drop:d.bind(s,this),greedy:!0,tolerance:"intersect",hoverClass:"dropover",scope:"moveable"});return this}}function t(a){a.preventDefault(),a.stopPropagation();var b;if(!!/draggable/.test(a.target.className)){b=c(a.target),b.draggable({revert:!0,revertDuration:120,cursor:"move",axis:"y",handle:".move",opacity:.7,snap:!0,zIndex:2700,scope:"moveable"});return this}}function s(a,b){a.preventDefault(),a.stopPropagation();var d=b.draggable,e=/file/.test(d[0].className)?"file":"dir",f=c(a.target).parent()[0].id,g=e==="file"?d.parents().filter("li.dir")[0].id:d.parent()[0].id,i=e==="file"?d[0].id.substr(5):undefined;this.collection.moveItem({type:e,destination:f,source:g,file:e==="file"?parseInt(i,10):i}).always(function(a){new h(null,a)})}function r(a){a=a instanceof e.Model?a:this.collection.get(a.directory.id);return this.renderPart(a)}function q(a,b){var c=b.find("input[type=text]").val();this.collection.createDir(c,a).always(function(a){b.off("click",".confirm"),b.remove();var c=new h(null,a)})}function o(a,b,c){var d=/dir/.test(a.id);d||this.trigger("select","remove",a);return n.call(this,a.id,d?"dir":"file")}function n(a,b){if(!this instanceof e.View)throw"function called with wrong context";var d=b==="file"?c("#file-"+a):c("#"+a),f=c([d,d.find(".dir-header")]).filter(function(){return this.data("draggable")||this.data("droppable")});this.dirViews[a]&&delete this.dirViews[a],d.detach(),setTimeout(function(){d.remove()},100);return this}function l(a){this[a.get("selected")?"selectById":"unselectById"](a.id)}function i(a,b){var c=this.collection.getFileById(parseInt(a.target.id.replace("select-file-",""),10)),d=b==="add"?"select":"unselect",e=b==="add"?!0:!1;this.trigger("select",b,c.toJSON()),c.set("selected",e)}return e.View.extend({events:{"click.dritree .toolbar":"tasks","click.dirtree .dir-header":"toggleDir","click.dirtree .file:not(.selected) > .text":"select","click.dirtree .file.selected > .text":"unselect","click.dirtree .file > .toolbar > .delete":"deleteFile","click.dirtree .dir-header > .toolbar > .delete":"deleteDir","click.dirtree .dir-header > .toolbar > .create":"createDir"},initialize:function(){this.collection=new f,this.dirViews={},this.collection.addSetting("field_id",this.options.field_id),this.collection.populate(),this.collection.deferred.done(d.bind(this.render,this)).fail(d.bind(C,this)),this.collection.on("add",d.bind(this.renderPart,this)),this.collection.on("remove",d.bind(o,this)),this.collection.on("update",d.debounce(d.bind(B,this),0)),this.collection.on("selected",d.bind(l,this)),p[this.collection.cid]={},this.searchView=new k({el:g.search_bar({id:"search-"+this.cid}),threshold:3,collection:this.collection}),this.$el.parent().find("label").after(this.searchView.$el),a["tree"+this.cid]=this},tasks:function(a){var b=c(a.target).parents().filter("li").find("ul")[0].id.substr(4),d=a.target.className.split(" ")[1];this.trigger(d,this.collection.get(b));return!1},select:function(a){i.call(this,a,"add")},unselect:function(a){i.call(this,a,"remove")},selectById:function(a){this.filesById(a).addClass("selected");return this},unselectById:function(a){this.filesById(a).removeClass("selected");return this},filesById:function(a){return c(d.isArray(a)?"#file-"+a.join(", #file-"):"#file-"+a)},getFile:function(a){return this.collection.getFileById(parseInt(a[0].id.split("file-")[1],10))},confirm:function(a){return confirm(a)},deleteDir:function(a){var d=this.collection.get(c(a.target).parents().filter(".dir")[0].id),e=b.Language.get(h.confirm_directory_deletion,{dir:d.get("name"),dir2:d.get("name"),dircount:d.get("subdirs")?d.get("subdirs").length:0,filecount:d.get("files")?d.get("files").models.length:0});this.confirm(e)&&this.collection.deleteItem(d,"dir").always(function(a){new h(null,a)})},deleteFile:function(a){var d=c(a.target),e=d.parents().filter(".file"),f=e.parent(),g=this.getFile(e),i=b.Language.get(h.confirm_file_deletion,{file:g.get("name")||g.get("path")});this.confirm(i)&&this.collection.deleteItem(g,"file").always(function(a){new h(null,a)}).done(function(){g.get("selected")&&g.set("selected",!1)})},createDir:function(a){var b=c(a.target),e=this.collection.get(b.parents().filter(".dir")[0].id),f=c(g.newdir({parent:e.get("path"),level:~~e.get("level")+1}));c("#sub-"+e.id).prepend(f),this.openDir(b.parents().filter(".dir")),f.on("click",".add",d.bind(q,this,e,f)),f.on("click",".cancel",function(){f.remove()})},toggleDir:function(a){var b,d,e,f,e;a.preventDefault(),a.stopPropagation(),b=c(a.target).parents().filter(".dir:not(#dir-list-root-"+this.collection.cid+")").first(),d=b.find("> .sub-dir"),f=b.hasClass("open")?"close":"open",e=f==="open"?"openDir":"closeDir",this[e](b)},openDir:function(a){j.isjQueryObject(a)&&(a.find("> .sub-dir").slideDown(),a.addClass("open"),this.collection.get(a[0].id).set("state","open"))},closeDir:function(a){a.find("> .sub-dir").slideUp(),a.removeClass("open"),this.collection.get(a[0].id).set("state","close")},enableTask:function(a,b){this.dirViews[b.id].trigger("enabletask",a)},disableTask:function(a,b){this.dirViews[b.id].trigger("disabletask",a)},renderPart:function(a){var b,c=this.dirViews[a.id]?!0:!1;c?(b=this.dirViews[a.id],b.model=a):(b=new m({tagName:"li",id:a.id,className:"dir level-"+a.get("level"),model:a}),this.dirViews[a.id]=b),b.render(this.options.dirSettings,this.options.fileSettings,c),c&&d.isArray(a.get("subdirs"))&&d.each(a.get("subdirs"),d.bind(r,this)),c&&this.trigger("update",b),x.call(this),z.call(this)},render:function(){var a=this;this.el.innerHTML=g.dirtree({name:this.options.baseName,cid:this.collection.cid}),this.collection.each(d.bind(this.renderPart,this))},getSubdirsFromView:function(a,b){var c=this,e=a.model.get("subdirs"),f=[];e&&d.each(e,function(a){c.dirViews[a.id]&&(f.push(c.dirViews[a.id]),b&&a.get("subdirs")&&f.push.apply(f,c.getSubdirsFromView(c.dirViews[a.id],!0)))});return f},getDirViewByModel:function(a){return this.dirViews[a.id]},getDirViewById:function(a){return this.dirViews[a]},getFileViewByModel:function(a){var b=this.getDirViewById(a.get("dir").id),c=b.getFileViewById(a.id);return c}})}();return o})})(this,this.Symphony,this.define)