/**
 * @package Views
 * @author thomas appel <mail@thomas-appel.com>

 * Displays <a href="http://opensource.org/licenses/gpl-3.0.html">GNU Public License</a>
 * @license http://opensource.org/licenses/gpl-3.0.html GNU Public License
 */

(function(a,b,c){c(["jquery","underscore","backbone","modules/mod_sysmessage","modules/mod_helper","templates/templates"],function(c,d,e,f,g,h){var i=c(a.document),j=function(){function k(a){a.preventDefault();var b=c([c(a.target),c(a.target).parents().filter("li")]).filter(function(){return this.hasClass("result-item")}),d=b[0][0].id.replace(/result/,"file");b.addClass("selected");var e=this.collection.getFileById(parseInt(d.substr(5),10));e.set("selected",!0)}function l(e){var g,i,k;a++,this.reset(),j=this.options.threshold,this.options.threshold=0,a=0,g=e.target,i=this.collection.searchFiles(g.value),k=i.length,this.counter=c(h.search_count({found:b.Language.get(f[k===1?"count_file_found":"count_files_found"],{count:k})})),d.each(i,d.bind(this.render,this)),this.field.after(this.counter)}function m(a){if(a.which!==27)return;this.reset(),this.field.val("").blur()}function n(){m.call(this,{which:27})}function o(a){var b=c("#result-"+a.id);b.length&&b[a.get("selected")?"addClass":"removeClass"]("selected")}function p(a){var b=c("#result-"+a.id);b.length&&b.remove()}function q(a){this.field.parent().addClass("active"),i.on("keyup.searchlist",d.bind(m,this))}function r(a){this.field.parent().removeClass("active"),i.off("keyup.searchlist")}var a=0,j;return e.View.extend({events:{"click.searchlist .result-item:not(.selected)":k,"focus.searchlist input[type=text]":q,"blur.searchlist input[type=text]":r,"click.searchlist .remove":n,"keyup.searchlist input[type=text]":l},initialize:function(){this.$el=c(h.search_bar({id:null})),this.el=this.$el.get(),this.el.id=this.options.id||"search-"+this.cid,this.template=h.search_list,this.list=this.$el.find(".results"),this.field=this.$el.find("input[type=text]"),this.collection.on("selected",d.bind(o,this)).on("filedelete",d.bind(p,this))},reset:function(){this.options.threshold=j,this.list.empty(),this.counter&&this.counter.remove()},render:function(a){var b=a.toJSON(),c;b.thumb=g.getThumbURL(a,"/image/2/40/40/5"),c=this.template(b),this.list.append(c)}})}();return j})})(this,this.Symphony,this.define)