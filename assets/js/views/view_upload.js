(function(a,b,c,d){b(["jquery","underscore","backbone","collections/col_upload","modules/mod_animate_circle","modules/mod_sysmessage","templates/templates"],function(a,b,c,d,e,f,g){var h=c.View.extend.call(function(){this.initialize.apply(this,arguments)},c.Events);h.extend=c.View.extend;var i=function(){},j=h.extend({initialize:function(){this.observable={},this.observable.children=[],this._callback=b.bind(i,this)},register:function(a,b){this.observable.parent=a,this.observable.children=b},listen:function(a){var c=this;this.on("condition",function(){b.each(c.observable._diff,function(b){b.on(a,c._callback)})})},condition:function(a){var c=this;this.observable.parent.on(a,function(){c.observable._diff=b.difference(c.observable.children,c.observable._diff),c.trigger("condition")})},setState:function(){}}),k=c.View.extend({events:{"click .send":"submit"},initialize:function(){this.collection=d.addList(),this.collection.field_id=this.options.field_id,this.collection.on("create",b.bind(this.add,this)),this._ulQueue=[]},add:function(b){var c=b.toJSON(),d;c.destination=this.options.destination,d=a(g.upload_list_item(c)),b.set("context",d),b.set("field_id",52),this.$el.append(d),d.data("circle",new e({canvas:d.find(".progress")[0],lineWidth:2,stepTime:400})),this._ulQueue.push(d)},createItem:function(a,b){this.collection.addItem(b)},_flushUlQueue:function(a){if(b.isFunction(a))while(this._ulQueue.length)a.call(this._ulQueue.pop());else this._ulQueue=[]},_flushUlItem:function(a){var c=b.indexOf(this._ulQueue,a);c>=0&&this._ulQueue.splice(c,1)},submitAll:function(){this._flushUlQueue(function(a){this.find(".send").trigger("click")})},submit:function(c){c.preventDefault();var d=a(c.target).parents().filter("tr"),e=d[0].id.split("send-")[1],f=this.collection.get(e);f.on("progress",b.bind(this.progress,this,f.get("context").data("circle"))),this.collection.send(e),this._flushUlItem(f.get("context"))},progress:function(a,b){a.animate(b)}}),l=function(){function l(a){this.trigger("remove",a),this.$el.remove()}function k(){var a=this.$el.data();this.$el.addClass("error"),a.progressIndicator.clearAnimation(),a.progressIndicator.drawFullCircle([255,0,0])}function j(){var a=this.$el.data();this.trigger("success",this.model,this._upld.resolve()),a.progressIndicator.clearAnimation(),a.progressIndicator.animate(100),a.progressValue.html("100&#160;%")}function i(a,b){a.progressIndicator.animate(b||0),a.progressValue.html(b?b+"&#160;%":"")}function h(){var a="."+b.toArray(arguments).join(", .");this.$el.find(a).toggleClass("disabled")}function f(){var a=g.upload_list_item(this.model.toJSON());this.undelegateEvents(),this.setElement(a)}function d(a){return new e({canvas:a,lineWidth:6,stepTime:250})}return c.View.extend({events:{"click.item .remove":"remove","click.item .start:not(.disabled)":"submit","click.item .cancel:not(.disabled)":"cancel"},initialize:function(){var c=this.model;this.model.on("change:file",b.bind(this.update,this)),this.model.on("success",b.bind(j,this)),this.model.on("error",b.bind(k,this)),this.model.on("destroyed",b.bind(l,this)),this._upld=a.Deferred()},update:function(a){var b=this.$el.find(".file-name");this.$el.addClass("success"),h.call(this,"cancel")},render:function(){this._parent=this.$el,f.call(this),this.$el.data("progress-indicator",d(this.$el.find(".progress")[0])),this.$el.data("progress-value",this.$el.find(".progress-text")),this.model.set("context",this._parent),this._parent.append(this.$el)},submit:function(a){a.stopPropagation(),a.preventDefault(),this.$el.data(""),this.model.on("progress",b.bind(i,this,this.$el.data())),this.trigger("upload",this.model,this._upld.promise()),h.call(this,"cancel","start")},cancel:function(a){a.stopPropagation(),a.preventDefault(),this.trigger("cancel",this.model,this._upld.reject()),h.call(this,"cancel","start"),this.$el.removeClass("success error"),i.call(this,this.$el.data(),0)},remove:function(a){a.stopPropagation(),a.preventDefault(),this.cancel(a),this.model.collection.remove(this.model)}})}(),m=function(){function r(){}function q(){}function p(a){var c=this,d=a.split(" "),e=this.collection,f=function(){var a={};b.each(d,function(b){a[b]=c.$el.find("."+b)});return a}();e.on("flush push",function(){e.models.length?f.remove.removeClass("disabled"):f.remove.addClass("disabled"),e.hasPendingUploads()?f.start.removeClass("disabled"):f.start.addClass("disabled"),e.hasActiveUploads()?f.cancel.removeClass("disabled"):f.cancel.addClass("disabled")})}function o(){this.trigger("fileuploaded")}function n(a,b){this.collection.cancel(b.id)&&(this._ulQueue.push(a),this.trigger("cancel"))}function m(a){this.collection.send(a.id).fail(function(a){new f(null,a)}),this.trigger("start")}function k(b){var c=a(b.target),d=c.clone();i(d),c.after(d),c.detach(),this.collection.addItem(c)}function j(a){this._ulQueue.push(a)}function i(b){var c=a("<form/>").append(b);c[0].reset();return b}function h(a){var c=b.indexOf(this._ulQueue,a);c>=0&&(this._ulQueue.splice(c,1),this.trigger("flushed"))}function e(a,c){if(b.isFunction(a))while(this._ulQueue.length)a.call(this._ulQueue.pop());else this._ulQueue=[];b.isFunction(c)&&c()}return c.View.extend({events:{"click .cancel:not(.small):not(.disabled)":"cancelAll","click .remove:not(.small):not(.disabled)":"removeAll","click .start:not(.small):not(.disabled)":"submitAll","click .close":"close","change input[type=file]":k},initialize:function(){this.collection=d.addList(),this.collection.on("create",b.bind(this.add,this)).on("invalidtype",b.bind(q,this)).on("filesizeexceeds",b.bind(r,this)),this._ulQueue=[]},render:function(c){var d=g.upload_list(b.extend(c.toJSON(),{destination:this.options.destination}));this._parent=this.$el,this.undelegateEvents(),this.setElement(d,!0),this._parent.append(this.el),this._listcontainer=a("#upload-container-"+c.id),p.call(this,"remove start cancel")},add:function(a){var c;a.set("field_id",this.options.field_id),c=new l({model:a,el:this._listcontainer||"#upload-container-"+a.id}),c.render(),this._ulQueue.push(c),a.on("success",b.bind(h,this,c)).on("success",b.bind(o,this,c)),c.on("cancel",b.bind(n,this,c)),c.on("upload",b.bind(h,this,c)),c.on("upload",b.bind(m,this)),this.trigger("add")},cancelAll:function(){this.$el.find(".file-list .cancel").trigger("click.item")},submitAll:function(){e.call(this,function(a){this.$el.find(".start").trigger("click.item")})},removeAll:function(){var a=this;this.collection.remove(this.collection.models)},close:function(a){a.stopPropagation(),a.preventDefault(),this.$el.remove(),this.trigger("remove")}})}(),n=c.View.extend({events:{"click .start-all":"start"},initialize:function(){this.files=[],this.collection=d,this.uploadList={},this._dirinstance=[]},toggleView:function(){this.$el.slideDown()},addUpload:function(a){var c=new m({el:"#uploads-"+this.cid,className:"row item upload-container",field_id:this.options.field_id,destination:a.get("path")}),d=this;c.render(a),c.on("remove",b.bind(this.collection.remove,this.collection,a.id)),c.on("remove",function(){d.collection.models.length||d.$el.slideUp()}),c.on("fileuploaded",b.bind(function(){d.trigger("fileuploaded",a)}))},render:function(){if(this._rendered)return!0;this.el.innerHTML=g.upload({id:this.cid}),this._rendered=!0},removeItem:function(){},start:function(){this.uploadList.submitAll()},createUpload:function(a){if(this.collection.get(a.id))return!1;if(this._rendered===!0)this.collection.add(a),this.addUpload(a),this.trigger("uploadcreate",a);else{this.render(),this.createUpload(a);return}this.toggleView()}});return n})})(this.Symphony,this.define,this)