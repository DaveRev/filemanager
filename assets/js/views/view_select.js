(function(a,b,c){var d=0,e=b.Context.get("root");a(["jquery","underscore","backbone","collections/col_select","modules/mod_sysmessage","modules/mod_helper","templates/templates"],function(a,b,c,d,e,f,g){function n(b,c){var d=c.index(),e=this;m.call(this,c),c.siblings().each(function(){m.call(e,a(this))}),this.collection.sort({silent:!0})}function m(a){var b=parseInt(a[0].id.replace("item-",""),10),c=a.index();this.collection.get(b).set({sorting:c},{silent:!0})}function l(a){}function k(a){this.collection[a.get("selected")?"add":"remove"](a)}function j(){}function i(){var a={error:{message:e.file_select_limit_exceed,context:{count:this.collection.settings.limit}}};return new e("error",a,!1)}function h(b){var c=a(this),d=c.find(".ordering"),e=d.offset().left,f=e+d.outerWidth(),g=b.pageX,h,i;window.getSelection&&window.getSelection().removeAllRanges(),g<e?(h=d.prev("li"),h.length>0&&(d.insertBefore(h),c.trigger("orderchange",[d]))):g>f&&(i=d.next("li"),i.length>0&&(d.insertAfter(i),c.trigger("orderchange",[d])))}var o=c.View.extend({events:{"click .remove":"removeFromList"},initialize:function(){this.collection=new d,this.dirtree=this.options.dirtree,this.fieldname=this.options.fieldname,this.dirtree.collection.on("selected",b.bind(k,this)),this.collection.on("add",b.bind(this.addItem,this)).on("remove",b.bind(this.removeItem,this)).on("add remove reset",b.bind(this.toggleState,this)),this.collection.on("selectionlimitexceed",b.bind(i,this)),this.template=this.options.mode==="compact"?g.selected_compact:g.selected_preview,this.label=this.$el.parent().find(".section-head"),this.$el.addClass(this.options.mode),this.options.sortable&&(this.$el.symphonyOrderable(),this.options.mode==="compact"&&this.$el.parent().on("mousemove.orderable",".ordering:has(.ordering)",h),this.$el.on("orderstop.orderable",b.bind(n,this))),this.prePopulate()},prePopulate:function(){var a=this,c=this.$el.find("input.file-selected"),d=[],e=[];e=this.dirtree.collection.deferred.done(function(){var d=0;c.each(function(){var b=a.dirtree.collection.getByFileName(this.value);b&&b.length&&(b[0].set({sorting:d++},{silent:!0}),b[0].set("selected",!0))}),a.$el.empty(),a.collection.sort(),a.collection.each(b.bind(a.addItem,a)),a.trigger("prepoulate",a.collection.pluck("id")),a.toggleState(),a.collection.record()})},toggleState:function(){this.collection.models.length?(this.$el.addClass("populated"),this.label.addClass("hidden")):(this.$el.removeClass("populated"),this.label.removeClass("hidden"))},getFiles:function(){return this.collection.pluck("path")},render:function(){var c=this,d="",e=this.template;this.collection.each(function(g){var h=g.toJSON();b.extend(h,{fieldname:c.fieldname,thumb:f.getThumbURL(g),draggable:c.options.sortable}),g.set({sorting:a("#item-"+g.id).index()},{silent:!0}),d+=e(h)}),this.el.innerHTML=d},addItem:function(c){var d=c.toJSON(),e,g;d.fieldname=this.fieldname,e=d.id,b.extend(d,{fieldname:this.fieldname,thumb:f.getThumbURL(c),draggable:this.options.sortable}),g=this.template(d),this.$el.append(g),c.set({sorting:a("#item-"+c.id).index()},{silent:!0})},removeItem:function(b){var c=b.id,d=a("#item-"+b.id);d.remove();return!0},removeFromList:function(a){var b=parseInt(a.target.id.split("remove-")[1],10),c=this.collection.get(b);c&&c.set("selected",!1)}});return o})})(this.define,this.Symphony,this.jQuery.noConflict())